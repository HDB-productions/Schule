<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Übung – Äquivalenzumformungen</title>
    <style>
      :root {
        --sp: 0.65rem;
        --c-bg: #fffce8;
        --c-user: #d7f8d7;
        --c-auto: #ffd6d6;
      }
      body {
        font-family: system-ui, sans-serif;
        margin: 0;
        padding: var(--sp) 1rem 2rem;
      }
      h1 {
        margin: 0 0 1.25rem;
        text-align: center;
      }

      /* Aktuelle Aufgabe */
      table.equation {
        width: min(560px, 100%);
        margin-inline: auto;
        border-collapse: collapse;
        background: var(--c-bg);
        border: 1px solid #ccc;
        table-layout: fixed;
      }
      col.eq-left,
      col.eq-right {
        width: 28%;
      }
      col.eq-op,
      col.eq-pipe {
        width: 4%;
      }
      col.eq-transform {
        width: 36%;
      }
      td {
        padding: 0.3rem 0.35rem;
      }
      td.separator {
        text-align: center;
      }
      td.text-right {
        text-align: right;
      }
      td.equation-cell {
        overflow-wrap: anywhere;
      }

      /* Historie */
      #history {
        margin-top: 2rem;
      }
      #history h2 {
        font-size: 1.05rem;
        text-align: center;
        margin-bottom: 0.5rem;
      }
      .history-table {
        width: min(560px, 100%);
        margin: 0.8rem auto;
        border: 1px solid #ccc;
        border-collapse: collapse;
      }
      .history-table td {
        padding: 0.3rem 0.35rem;
      }
      .history-table .user-cell {
        background: var(--c-user);
      }
      .history-table .auto-cell {
        background: var(--c-auto);
      }

      /* Input & Buttons */
      .answer-input {
        width: 100%;
        box-sizing: border-box;
        font: inherit;
        padding: 0.15rem 0.25rem;
      }
      td:nth-child(5) .answer-input {
        min-width: 11rem;
      }
      .answer-input.error {
        border: 2px solid red;
        animation: shake 0.15s 3;
      }
      @keyframes shake {
        0% {
          transform: translateX(-2px);
        }
        50% {
          transform: translateX(2px);
        }
        100% {
          transform: translateX(0);
        }
      }
      .button-container {
        display: flex;
        justify-content: center;
        gap: 1.25rem;
        margin-top: 1.4rem;
      }
      button {
        padding: 0.45rem 1rem;
        font: inherit;
        border: 1px solid #777;
        border-radius: 6px;
        background: #fafafa;
        cursor: pointer;
      }
      button.hidden {
        display: none;
      }

      @media (max-width: 480px) {
        table.equation,
        .history-table {
          font-size: 0.9rem;
        }
      }
    </style>
    <!-- html2canvas für Export -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
      integrity="sha512-sn+GjvEPNi19hYz3Rv6/K5S+6Jx/BjQj0mXoQIS3RykR7Y0mf5eKQZ/ONuXgG1dnLBb8BQjohmI4Y49d6a7pVA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
  </head>
  <body>
    <h1>Löse die Gleichung durch Äquivalenz­umformungen</h1>

    <table class="equation" id="eqTable">
      <colgroup>
        <col class="eq-left" />
        <col class="eq-op" />
        <col class="eq-right" />
        <col class="eq-pipe" />
        <col class="eq-transform" />
      </colgroup>
      <tbody>
        <tr>
          <td id="g1l" class="equation-cell text-right"></td>
          <td class="separator">=</td>
          <td id="g1r" class="equation-cell"></td>
          <td class="separator">|</td>
          <td id="u1" class="equation-cell"></td>
        </tr>
        <tr>
          <td id="g2l" class="equation-cell text-right"></td>
          <td class="separator">=</td>
          <td id="g2r" class="equation-cell"></td>
          <td class="separator">|</td>
          <td id="u2" class="equation-cell"></td>
        </tr>
        <tr>
          <td id="g3l" class="equation-cell text-right"></td>
          <td class="separator">=</td>
          <td id="g3r" class="equation-cell"></td>
          <td class="separator">|</td>
          <td id="u3" class="equation-cell"></td>
        </tr>
        <tr>
          <td id="g4l" class="equation-cell text-right"></td>
          <td class="separator">=</td>
          <td id="g4r" class="equation-cell"></td>
          <td class="separator"></td>
          <td class="equation-cell"></td>
        </tr>
      </tbody>
    </table>

    <div class="button-container">
      <button id="checkBtn">Prüfen</button>
      <button id="newBtn">Neue Aufgabe</button>
      <button id="exportBtn">Exportiere Historie</button>
    </div>

    <section id="history"><h2>Bisherige Aufgaben</h2></section>

    <script>
      (() => {
        "use strict";
        const $ = (s) => document.querySelector(s);
        const rand = (n) => Math.floor(Math.random() * (2 * n + 1)) - n;
        const sg = (n) => (n < 0 ? "-" : "+");
        const abs = Math.abs;
        const norm = (s) => {
          let t = s.replace(/\s+/g, "").toLowerCase();
          t = t.replace(/^x/, "1x").replace(/([+-])x/g, "$11x");
          return t.replace(/\*\(-1\)/g, ":(-1)");
        };

        let step = 0,
          coeffs = {},
          texts = {};
        const eqIDs = [
          "g1l",
          "g1r",
          "u1",
          "g2l",
          "g2r",
          "u2",
          "g3l",
          "g3r",
          "u3",
          "g4l",
          "g4r",
        ];

        function newCoeffs() {
          let a1, a2, a3, L;
          do {
            a1 = rand(10);
          } while (a1 === 0 || a1 === 1);
          do {
            a3 = rand(10);
          } while (a3 === 0 || a3 === -a1);
          L = rand(10);
          do {
            a2 = rand(10);
          } while (a2 === 0 || a2 === -L * a1);
          return { a1, a2, a3, L };
        }

        function buildTexts({ a1, a2, a3, L }) {
          return {
            g1l: `${a1 + a3}x ${sg(a2)} ${abs(a2)}`,
            g1r: `${a1 * L + a2} ${sg(a3)} ${abs(a3)}x`,
            u1: `${sg(-a3)} ${abs(a3)}x`,
            g2l: `${a1}x ${sg(a2)} ${abs(a2)}`,
            g2r: `${a1 * L + a2}`,
            u2: `${sg(-a2)} ${abs(a2)}`,
            g3l: `${a1}x`,
            g3r: `${a1 * L}`,
            u3: a1 < 0 ? `:(-${abs(a1)})` : `:${abs(a1)}`,
            g4l: `x`,
            g4r: `${L}`,
          };
        }

        const steps = [
          {
            c: "u1",
            p: "Bringe alle x nach links.",
            a: (t) => t.u1,
            show: (t) => ({ g1l: t.g1l, g1r: t.g1r }),
          },
          {
            c: "g2l",
            p: "Vereinfache.",
            a: (t) => t.g2l,
            show: (t) => ({ u1: t.u1 }),
          },
          {
            c: "g2r",
            p: "Vereinfache.",
            a: (t) => t.g2r,
            show: (t) => ({ g2l: t.g2l }),
          },
          {
            c: "u2",
            p: "Konstante entfernen.",
            a: (t) => t.u2,
            show: (t) => ({ g2r: t.g2r }),
          },
          {
            c: "g3l",
            p: "Vereinfache.",
            a: (t) => t.g3l,
            show: (t) => ({ u2: t.u2 }),
          },
          {
            c: "g3r",
            p: "Vereinfache.",
            a: (t) => t.g3r,
            show: (t) => ({ g3l: t.g3l }),
          },
          {
            c: "u3",
            p: "Durch Koeffizient teilen.",
            a: (t) => t.u3,
            show: (t) => ({ g3r: t.g3r }),
          },
          {
            c: "g4l",
            p: "Vereinfache.",
            a: (t) => t.g4l,
            show: (t) => ({ u3: t.u3 }),
          },
          {
            c: "g4r",
            p: "Vereinfache.",
            a: (t) => t.g4r,
            show: (t) => ({ g4l: t.g4l }),
          },
        ];

        function clearTable() {
          eqIDs.forEach((id) => ($(`#${id}`).textContent = ""));
        }
        function showGiven(i) {
          Object.entries(steps[i].show(texts)).forEach(
            ([id, v]) => ($(`#${id}`).textContent = v)
          );
        }
        function addInput(i) {
          const cfg = steps[i],
            cell = $(`#${cfg.c}`);
          cell.dataset.expect = cfg.a(texts);
          cell.innerHTML = `<input class="answer-input" placeholder="${cfg.p}">`;
          cell.querySelector("input").focus();
        }

        function archive() {
          const clone = $(`#eqTable`).cloneNode(true);
          clone.removeAttribute("id");
          clone.classList.replace("equation", "history-table");
          clone.querySelectorAll("td").forEach((td) => {
            const inp = td.querySelector("input");
            if (inp) {
              const v = inp.value.trim();
              td.textContent = v || " ";
              td.classList.add(v ? "user-cell" : "auto-cell");
            } else if (td.dataset.userFill) td.classList.add("user-cell");
            td.removeAttribute("data-user-fill");
          });
          $("#history").appendChild(clone);
        }

        function check() {
          const cfg = steps[step],
            cell = $(`#${cfg.c}`),
            inp = cell.querySelector("input");
          if (!inp) return;
          if (norm(inp.value) === norm(cell.dataset.expect)) {
            cell.textContent = inp.value.trim() || " ";
            cell.dataset.userFill = true;
            step++;
            if (step < steps.length) {
              showGiven(step);
              addInput(step);
            } else {
              $("#checkBtn").classList.add("hidden");
            }
          } else {
            inp.classList.add("error");
            setTimeout(() => inp.classList.remove("error"), 300);
          }
        }

        function newExercise() {
          if (step > 0 || $(`#g1l`).textContent) archive();
          clearTable();
          coeffs = newCoeffs();
          texts = buildTexts(coeffs);
          step = 0;
          $("#checkBtn").classList.remove("hidden");
          showGiven(0);
          addInput(0);
        }

        function exportHistory() {
          const hist = document.querySelector("#history");
          html2canvas(hist).then((canvas) => {
            const link = document.createElement("a");
            link.download = "history.png";
            link.href = canvas.toDataURL();
            link.click();
          });
        }

        document.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && e.target.matches(".answer-input")) check();
        });
        $("#checkBtn").addEventListener("click", check);
        $("#newBtn").addEventListener("click", newExercise);
        $("#exportBtn").addEventListener("click", exportHistory);

        newExercise();
      })();
    </script>
  </body>
</html>
